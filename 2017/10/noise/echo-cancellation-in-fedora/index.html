<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  
  <meta property="og:title" content="Noise/Echo Cancellation in Fedora" />
  <meta name="twitter:title" content="Noise/Echo Cancellation in Fedora" />
  
  <title>Noise/Echo Cancellation in Fedora - clayto</title>

  
  <meta name="description" content="How to enable PulseAudio noise and echo cancellation in Fedora 26-29." />
  <meta property="og:description" content="How to enable PulseAudio noise and echo cancellation in Fedora 26-29." />
  <meta name="twitter:description" content="How to enable PulseAudio noise and echo cancellation in Fedora 26-29." />
  

  <meta name="author" content="" />
  <meta property="og:site_name" content="clayto" />
  <meta property="og:url" content="https://clayto.com/2017/10/noise/echo-cancellation-in-fedora/" />

  
    
    
  <meta property="og:image" content="https://clayto.com/2017/10/noise/echo-cancellation-in-fedora/./after.jpg" />
  <meta
    name="twitter:image"
    content="https://clayto.com/2017/10/noise/echo-cancellation-in-fedora/./after.jpg"
  />
  
  <meta name="twitter:card" content="summary" />

  
  <meta name="twitter:site" content="@mwcz" />
  <meta name="twitter:creator" content="@mwcz" />
   
  <meta property="og:type" content="article" />
   
  
  <meta name="generator" content="Hugo 0.98.0" /><link media="screen"
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600"
    rel="stylesheet"
  />
  <link media="screen" rel="stylesheet" href="https://clayto.com/css/styles.min.css" />

  
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://clayto.com/images/favicons/apple-touch-icon.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://clayto.com/images/favicons/favicon-32x32.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://clayto.com/images/favicons/favicon-16x16.png?v=alQ2onMqbL"
  />
  <link rel="manifest" href="https://clayto.com/images/favicons/site.webmanifest?v=alQ2onMqbL" />
  <link
    rel="mask-icon"
    href="https://clayto.com/images/favicons/safari-pinned-tab.svg?v=alQ2onMqbL"
    color="#121212"
  />
  <link rel="shortcut icon" href="https://clayto.com/images/favicons/favicon.ico?v=alQ2onMqbL" />
  <meta name="msapplication-TileColor" content="#121212" />
  <meta
    name="msapplication-config"
    content="/images/favicons/browserconfig.xml?v=alQ2onMqbL"
  />
  <meta name="theme-color" content="#121212" />
   
  
  <a rel="me" href="https://mastodon.social/@mwcz" style="display: none">Mastodon</a>

</head>

<body>
  
  
  
  
  
  
  
  
  
  
  
  
<header class="pbp-navbar-container">
  
<nav class="pbp-navbar" role="navigation">
  <div class="pbp-nav-logo">
    <a href="https://clayto.com/" title="Home" id="pbp-logo">
      <img src="https://clayto.com/images/logo.png" height="50.4" width="50.4" alt="smiling clayto.com logo">
    </a>
  </div>
  <div class="pbp-navitems">
    
    
    
    <a href="https://clayto.com/" class="pbp-navitem">
      &nbsp;BLOG</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/demos" class="pbp-navitem">
      &nbsp;DEMOS</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/games" class="pbp-navitem">
      &nbsp;GAMES</a>
    
    
  </div>
</nav>




</header>
  <main id="main" role="main" class="container">




  <article class="pbp-article">

  <header>
    <h1>Noise/Echo Cancellation in Fedora</h1>
  </header>

  
  <figure class="pbp-post-hero">
    <img src="./minimic.jpg">
  </figure>
  

  <div class="pbp-article-meta">
    <time datetime="2017-10-12T00:00:00Z">
      Oct 12, 2017
    </time>
    
    <time datetime="2019-04-01T00:00:00Z">
      (updated Apr 1, 2019)
    </time>
    
    <span class="pbp-blue">&middot;</span>
    3 minute read
    <br>
    <span class="pbp-article-tags">
      
      <a href="https://clayto.com/tags/linux" class="c-tag">#linux</a>
      
      <a href="https://clayto.com/tags/fedora" class="c-tag">#fedora</a>
      
      <a href="https://clayto.com/tags/audio" class="c-tag">#audio</a>
      
    </span>
  </div>

  
  
  <section>
    <p>The Minimic is great. I just received mine last week, and I&rsquo;m loving the ability to join video calls with <a href="http://gradolabs.com/">nice, comfy headphones</a>. It&rsquo;s much better than switching back and forth between headphones and a headset.</p>
<p>The only problem is that, since the minimic is just <em>a wire</em>, it doesn&rsquo;t have any noise or echo cancellation. And since Fedora doesn&rsquo;t come with that feature enabled by default, the mic was picking up a lot of ambient noise. <a href="https://chrisbredesen.com/">Breddy</a> told me that steps just like the following didn&rsquo;t work in Fedora a few versions ago, so I wanted to document them now that the issues seem to be fixed. I originally found these instructions on <a href="https://www.reddit.com/r/linux/comments/2yqfqp/just_found_that_pulseaudio_have_noise/">this r/linux post</a> and am reposting them here with Fedora-specific flourishes.</p>
<p>Without further ado, here&rsquo;s how to turn on noise and echo cancellation in Fedora 26. <strong>Update</strong>: also works in Fedora 27 (and 28 (and 29!)!).</p>
<hr>
<h1 id="just-gimme-it">Just gimme it</h1>
<p>If you&rsquo;re in a rush, here&rsquo;s a script that will set everything up for you.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo dnf install -y webrtc-audio-processing
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;.nofail&#39;</span> | sudo tee -a /etc/pulse/default.pa
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;load-module module-echo-cancel aec_method=webrtc source_name=echosource&#39;</span> | sudo tee -a /etc/pulse/default.pa
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;set-default-source echosource&#39;</span> | sudo tee -a /etc/pulse/default.pa
</span></span><span style="display:flex;"><span>echo <span style="color:#e6db74">&#39;.fail&#39;</span> | sudo tee -a /etc/pulse/default.pa
</span></span><span style="display:flex;"><span>pulseaudio -k
</span></span></code></pre></div><p>Your noise-cancelled input device should now be available.  If it&rsquo;s no longer available after your next reboot, see the [missing input device addendum][#startup-addendum].</p>
<p>Updated on 2019-04-01: added <code>set-default-source</code> to automatically set the noise cancelled device as the default.</p>
<hr>
<h1 id="again-but-with-explanation">Again, but with explanation</h1>
<p>The first step is to install the WebRTC audio processing package. It <em>may</em> come by default with Fedora. My machine had it installed already, but I&rsquo;m including it here in case it was simply a dependency of some other package I&rsquo;ve installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo dnf install webrtc-audio-processing
</span></span></code></pre></div><p>Then add these two lines to the end of <code>/etc/pulse/default.pa</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>.nofail
</span></span><span style="display:flex;"><span>load-module module-echo-cancel aec_method<span style="color:#f92672">=</span>webrtc
</span></span><span style="display:flex;"><span>.fail
</span></span></code></pre></div><p>Then restart PulseAudio.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>pulseaudio -k
</span></span></code></pre></div><p>Now, if you open Sound settings, you should see a new entry under the <em>Input</em> tab. Mine is called &ldquo;<strong>Built-in Audio Analog Stereo (echo cancelled with SA9027 USB Audio Analog Stereo)</strong>&rdquo;. Not sure what&rsquo;s up with that name; my mic is connected with a 3.5mm audio jack. Whatever, it works!</p>
<figure>
    <img src="devices.png">
</figure>
<p>Select the device that says &ldquo;echo cancelled&rdquo; and your audio background hiss should drop to almost nothing. Here&rsquo;s a before and after spectrum analysis.</p>
<div class="beside">
    <figure>
        <img src="before.jpg" alt="Audio spectrum analysis of microphone input without noise cancellation." />
        <figcaption>Spectrum analysis without noise cancellation.</figcaption>
    </figure>
    <figure>
        <img src="after.jpg" alt="Audio spectrum analysis of microphone input with noise cancellation." />
        <figcaption>Spectrum analysis <b>with</b> noise cancellation.</figcaption>
    </figure>
</div>
<h1 id="missing-input-device-addendum">Missing input device addendum</h1>
<p>After using this trick for the past few Fedora releases, I&rsquo;ve been stumped by why the noise-cancelled input device doesn&rsquo;t automatically show up after a fresh boot.  I always have to run <code>pulseaudio -k</code> manually after rebooting to get the device to appear.</p>
<p>I haven&rsquo;t found a solution for the core problem yet, but a workaround is to automatically restart PulseAudio upon loggin in.  Here&rsquo;s a script which sets that up.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>mkdir -p ~/.config/autostart
</span></span><span style="display:flex;"><span>cat &gt; ~/.config/autostart/restart-pulseaudio.desktop <span style="color:#e6db74">&lt;&lt; EOF
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[Desktop Entry]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Comment=Kill pulseaudio to trigger automatic restart, so that my config will be loaded properly.  I don&#39;t know why.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Terminal=false
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Name=Restart PulseAudio
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Exec=bash -c &#34;pulseaudio -k&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Type=Application
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>Good luck!  I hope this advice <em>is sound</em>.</p>

  </section>
  <footer>

    

    

    




  </footer>
</article>



  </main>
  <footer class="container">
    <section class="pbp-footer">
      
<aside>
  
    <small class="footer-label">CONTACT ME</small>
    
    
    
    
<ul class="pbp-social-links">
  
  <li>
    <a title="Email me" href="mailto:mwc@clayto.com">
      <span class="icon-mail"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my GitHub activity" href="https://github.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-github-squared"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my CodePens" href="https://codepen.io/mwcz" target="_blank" rel="noopener">
      <span class="icon-codepen"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my Twitter" href="https://twitter.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-twitter-squared"></span>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  <li>
    <a title="my Vimeo videos" href="https://vimeo.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-vimeo-squared"></span>
    </a>
  </li>
  
  
  
</ul>


  
</aside>


    </section>

    
    
    
    
    

    
    
    
    
    
    
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js"></script>
  <script>
    anchors.options.visible = 'touch';
    anchors.options.placement = 'right';
    anchors.options.class = 'heading-anchor';
    anchors.add('article > section h1,article > section h2,article > section h3,article > section h4,article > section h5,article > section h6');
  </script>

  
    
  

</body>
</html>

