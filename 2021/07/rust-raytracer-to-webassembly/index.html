<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  
  <meta property="og:title" content="Rust Raytracer to WebAssembly" />
  <meta name="twitter:title" content="Rust Raytracer to WebAssembly" />
  
  <title>Rust Raytracer to WebAssembly - clayto</title>

  
  <meta name="description" content="The work of preparing my Rust ray tracer for WebAssembly." />
  <meta property="og:description" content="The work of preparing my Rust ray tracer for WebAssembly." />
  <meta name="twitter:description" content="The work of preparing my Rust ray tracer for WebAssembly." />
  

  <meta name="author" content="" />
  <meta property="og:site_name" content="clayto" />
  <meta property="og:url" content="https://clayto.com/2021/07/rust-raytracer-to-webassembly/" />

  
  <meta property="og:image" content="https://clayto.com/2021/07/rust-raytracer-to-webassembly/thumb.jpg" />
  <meta
    name="twitter:image"
    content="https://clayto.com/2021/07/rust-raytracer-to-webassembly/thumb.jpg"
  />
  
  <meta name="twitter:card" content="summary" />

  
  <meta name="twitter:site" content="@mwcz" />
  <meta name="twitter:creator" content="@mwcz" />
   
  <meta property="og:type" content="article" />
   
  
  <meta name="generator" content="Hugo 0.81.0" /><link media="screen"
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600"
    rel="stylesheet"
  />
  <link media="screen" rel="stylesheet" href="https://clayto.com/css/styles.min.css" />

  
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://clayto.com/images/favicons/apple-touch-icon.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://clayto.com/images/favicons/favicon-32x32.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://clayto.com/images/favicons/favicon-16x16.png?v=alQ2onMqbL"
  />
  <link rel="manifest" href="https://clayto.com/images/favicons/site.webmanifest?v=alQ2onMqbL" />
  <link
    rel="mask-icon"
    href="https://clayto.com/images/favicons/safari-pinned-tab.svg?v=alQ2onMqbL"
    color="#121212"
  />
  <link rel="shortcut icon" href="https://clayto.com/images/favicons/favicon.ico?v=alQ2onMqbL" />
  <meta name="msapplication-TileColor" content="#121212" />
  <meta
    name="msapplication-config"
    content="/images/favicons/browserconfig.xml?v=alQ2onMqbL"
  />
  <meta name="theme-color" content="#121212" />
   
  
  

</head>

<body>
  
  
  
  
  
  
  
  
  
  
  
  
<header class="pbp-navbar-container">
  
<nav class="pbp-navbar" role="navigation">
  <div class="pbp-nav-logo">
    <a href="https://clayto.com/" title="Home" id="pbp-logo">
      <img src="https://clayto.com/images/logo.png" height="50.4" width="50.4" alt="smiling clayto.com logo">
    </a>
  </div>
  <div class="pbp-navitems">
    
    
    
    <a href="https://clayto.com/" class="pbp-navitem">
      &nbsp;BLOG</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/demos" class="pbp-navitem">
      &nbsp;DEMOS</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/games" class="pbp-navitem">
      &nbsp;GAMES</a>
    
    
  </div>
</nav>




</header>
  <main id="main" role="main" class="container">




  <article class="pbp-article">

  <header>
    <h1>Rust Raytracer to WebAssembly</h1>
  </header>

  

  <div class="pbp-article-meta">
    <time datetime="2021-07-05T23:57:49-04:00">
      Jul 5, 2021
    </time>
    
    <span class="pbp-blue">&middot;</span>
    13 minute read
    <br>
    <span class="pbp-article-tags">
      
      <a href="https://clayto.com/tags/3d" class="c-tag">#3d</a>
      
      <a href="https://clayto.com/tags/programming" class="c-tag">#programming</a>
      
      <a href="https://clayto.com/tags/ray-tracing" class="c-tag">#ray-tracing</a>
      
      <a href="https://clayto.com/tags/rust" class="c-tag">#rust</a>
      
      <a href="https://clayto.com/tags/web" class="c-tag">#web</a>
      
      <a href="https://clayto.com/tags/wasm" class="c-tag">#wasm</a>
      
    </span>
  </div>

  
  
  <section>
    <h2 id="recap">RECAP</h2>
<p>To set the scene, here&rsquo;s what was in place at the end of the <a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">last post</a>.</p>
<ul>
<li>one Rust ray tracer, runnable from the command-line only</li>
<li>an interest in WebAssembly</li>
<li>one mistaken assumption that could ruin everything</li>
</ul>
<h2 id="i-set-out-to">I SET OUT TO&hellip;</h2>
<p>This post covers getting that ray-tracer running in <a href="https://webassembly.org/">WebAssembly</a>.</p>
<h2 id="it-went">IT WENT&hellip;</h2>
<p>The process of targeting WebAssembly went well, overall.  These were the highlights of the journey.</p>
<ul>
<li>
<p>Crate refactoring to support a CLI and WebAssembly module.</p>
</li>
<li>
<p>Distributing highly-visual WebAssembly modules using Web Workers and Web Components.</p>
</li>
<li>
<p>A staggering performance degradation caused by millions of excessive wasm-to-js calls.</p>
</li>
<li>
<p>A Rust implementation of a blazing-fast random number generator.</p>
</li>
<li>
<p>Comparing native performance measurements with WebAssembly.</p>
</li>
<li>
<p>Performance tanking whenever devtools was open.</p>
</li>
<li>
<p>Some conventional front-end performance optimizations.</p>
</li>
</ul>
<p>Before diving in too deep, here&rsquo;s the result, the ray tracer from my previous post, running right here in this blog post, at speeds pretty close to native.</p>
<script async type="module" src="./rtw-render/dist/rtw-render.js"></script>
<style>
rtw-render {
  --rtw-background-color: var(--pbp-bg-color);

  border: 1px solid var(--pbp-fg-color);

}
</style>
<center>
<rtw-render></rtw-render>
</center>
<h2 id="crate-refactoring">Crate refactoring</h2>
<p>At the end of the previous post, the ray tracer was implemented in a single binary crate.  To re-use that code for a WebAssembly target as well, the first thing I did was move the ray tracing code into a library crate.</p>
<p>The original binary crate then imported the library crate, so the ray tracer can still be run on the command line.  I created a third crate, <code>wasm</code>, with wasm-pack.  This one also imports the library crate, does some small amount of extra work to make the ray tracing output consumable by WebAssembly, and exports that function to wasm with <code>#[wasm_bindgen]</code>.</p>
<p>TODO consider removing the stuff about return types, or moving it to the Web Component section</p>
<p>The extra work in question was a simple change in output format.  The ray tracer&rsquo;s <code>render</code> function returns a <code>Vec&lt;Vec3&lt;f64&gt;&gt;</code>, or in plain English, an array of RGB color objects with 64-bit precision.  Two of the types, <code>Vec</code> and <code>f64</code>, are core Rust types, which wasm-bindgen knows how to pass to JS.  <code>Vec3</code> is a custom type I wrote for the ray tracer.  As a result, the first error I encountered had to do with wasm-bindgen rejecting <code>Vec3</code> as an unknown type, since it had no idea how to convert it into JS.  Makes sense!</p>
<p>Granted, it&rsquo;s absolutely possible to teach wasm-bindgen how to convert custom types into JS, but I was in a hurry to get things running, so I took the easy way out and simply squished the <code>Vec&lt;Vec3&lt;f64&gt;&gt;</code> into a <code>Vec&lt;u8&gt;</code>.  This accomplished two things.  First, it took my custom type out of the equation.  Second, when passed to JS, <code>Vec&lt;u8&gt;</code> is ready to be used as a <code>Uint8ClampedArray</code>, ideal for drawing the image in a canvas.  This involved inefficient copying of data, but it was fully eclipsed by other performance bottlenecks.</p>
<p>With those changes, I had a working WebAssembly module.  Here&rsquo;s the first rendering, with very low quality settings but still very exciting!</p>
<p><img src="screenshots/first-wasm-render.png" alt="a screenshot of the very first WebAssembly rendering of my ray tracer"></p>
<h2 id="the-wwwwww-pattern">The WWWWWW Pattern</h2>
<p>The demo above is a WebAssembly module running inside a Web Worker, Wrapped in a Web Component&hellip; on a Web Site, in a Web Browser.  Others are using this same pattern, but to my knowledge it doesn&rsquo;t yet have a silly name.  So, I&rsquo;m dubbing it the <strong>WWWWWW</strong> pattern.  Too many syllables, you say?  I&rsquo;m just following in the footsteps of the man himself.</p>
<figure>
<img src="./wtw-excerpt.jpg" alt="excerpt from Weaving the Web, by Tim Berners-Lee, about how he received early criticism for his &quot;WWW&quot; acronym containing nine syllables" />
<figcaption>Tim Berners-Lee, Weaving the Web</figcaption>
</figure>
<p>Silly names aside, Web Components and Web Workers do complement WebAssembly beautifully.  I&rsquo;d like to write more about WWWWWW, but that&rsquo;ll be a topic for another post.  Back to the ray tracer.</p>
<h2 id="performance">Performance</h2>
<p>Initially, the performance of the WebAssembly module seemed pretty good.  The quality settings were at rock bottom to make the edit/save/refresh/observe loop tighter.  Once I turned the quality settings back up to their defaults, I was stunned.  The performance was awful.  The WebAssembly module ran <strong>12x</strong> slower than the native binary.  Under some conditions, I even saw it degrade to <strong>60x</strong> native speed.  I won&rsquo;t leave anyone in suspense though, the WebAssembly execution speed was not the cause of the slowdown.  WebAssembly is very fast.</p>
<p>Below I&rsquo;ll go into why the performance was so poor initially, where the bottlenecks were, and how I corrected them.</p>
<h3 id="mangle-shmangle">Mangle shmangle</h3>
<p>The first test I ran was a performance profile in Chrome devtools, which generates an interactive flame chart for JS and WebAssembly.  The initial results were&hellip; unhelpful.</p>
<p><img src="screenshots/profile-mangled-names.png" alt="screenshot of the mangled names"></p>
<p>Adding the two following settings to the Cargo.toml resulted in more useful names.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">package</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">pack</span>.<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">opt</span> = <span style="color:#66d9ef">false</span>

[<span style="color:#a6e22e">package</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">pack</span>.<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">bindgen</span>]
<span style="color:#a6e22e">demangle</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">name</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">section</span> = <span style="color:#66d9ef">true</span>
</code></pre></div><p><img src="screenshots/profile-demangled-names.png" alt="screenshot of demangled names"></p>
<p>With the flame chart now usable, the bottleneck jumped off the screen.</p>
<p><img src="./screenshots/rng-eighty-percent.png" alt="RNG was 80% of the cost"></p>
<p>80% of the</p>
<h3 id="rngesus-giveth-and-taketh-away">RNGesus Giveth and Taketh Away</h3>
<p>The flame chart revealed that 80% of the ray tracer&rsquo;s duration consisted of calls to <a href="https://crates.io/crates/rand">rand</a>, an RNG crate.  I&rsquo;d chosen rand because it had WebAssembly support, and includes no calls to the standard library, which tends to cut down on <code>.wasm</code> file size.  What I hadn&rsquo;t noticed until digging into the flame chart, is that when rand is in the WebAssembly context, it makes calls out to JS (<code>crypto.getRandomValues()</code>).  And the way I was misusing rand, it was making <em>a lot</em> of those calls.</p>
<p>RNG is needed throughout the ray tracer, and I didn&rsquo;t know of any way in Rust to create a single, global RNG that every corner of the program could make calls to.  Instead, I inefficiently initialized a new RNG every time a random number was needed.</p>
<p>This left me with two problems to solve.</p>
<ol>
<li>find a way to share a single RNG</li>
<li>avoid JS calls</li>
</ol>
<p>After some experimentation, I settled on implementing <a href="https://lemire.me/blog/2019/03/19/the-fastest-conventional-random-number-generator-that-can-pass-big-crush/">lehmer64</a>, and sharing it with <a href="https://crates.io/crates/lazy_static">lazy_static</a>.</p>
<p><strong>lib.rs</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> lazy_static::lazy_static;
<span style="color:#66d9ef">use</span> std:<span style="color:#a6e22e">sync</span>:<span style="color:#a6e22e">Mutex</span>;

lazy_static<span style="color:#f92672">!</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">ref</span> RNG: <span style="color:#a6e22e">Mutex</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u128</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Mutex::new(<span style="color:#ae81ff">0xda942042e4dd58b5</span>);
}
</code></pre></div><p>Here&rsquo;s the <a href="https://github.com/mwcz/rust-raytracer-weekend/blob/wasm/lib/src/random.rs">Rust implementation of lehmer64</a>.  Here, the initial seed is all that&rsquo;s shared, and it gets rewritten by each call to <code>random_float</code>.  After the compiler asked me (politely) to add <a href="https://doc.rust-lang.org/std/num/struct.Wrapping.html">Wrapping</a> to indicate that yes, I want integer overflow, it worked.  Performance improved a lot, but not as much as I expected.</p>
<p>The culprit, taking up 18.5% of total time, was <a href="https://github.com/libdfp/libdfp">floatuntidf</a>.   It&rsquo;s a C floating point library.  According to <a href="https://github.com/rust-lang/compiler-builtins">compiler-builtins</a>, it&rsquo;s in the process of being ported to Rust.  My guess is that my conversion of a <code>u128</code> to <code>f64</code> activated floatuntidf.  I lowered the precision to <code>u64/f32</code> for a free 18.% performance boost with no noticable change in image quality.</p>
<p>When this fell into place, the WebAssembly module&rsquo;s speed is breathing down the neck of native!  In one test, the WebAssembly runs at 1.13x.</p>
<table>
<thead>
<tr>
<th>Average total time</th>
<th>Standard deviation</th>
</tr>
</thead>
<tbody>
<tr>
<td>399.20 ms</td>
<td>± 4.30 ms</td>
</tr>
<tr>
<td>452.05 ms</td>
<td>± 10.85 ms</td>
</tr>
</tbody>
</table>
<p>Native measurements were captured over 30 runs with <a href="https://github.com/sharkdp/hyperfine">hyperfine</a>.  WebAssembly measurements were captured over 30 runs with the Chrome devtools profiler.</p>
<p>Only 1.13x native speeds, not bad!  That&rsquo;s within the range I&rsquo;ve heard to expect from WebAssembly.  Under other conditions I&rsquo;ve seen the WebAssembly module perform worse.  1.5x native speed seems like the worst case, and 1.13x is the best case for my particular module.  The comparison still may not be perfectly fair to the WebAssembly module though, because its measurements are taken with profiling active which surely impacts performance somewhat.</p>
<h4 id="overheated-mutex">Overheated Mutex</h4>
<p>One piece of low-hanging fruit that I haven&rsquo;t pruned yet is the Mutex from the code snippet above, which gets extremely overheated. It&rsquo;s used to share mutable access to the RNG seed.  Random numbers are needed throughout the ray tracer, and several are generated per ray.  The quantity of random numbers generated can easily reach into the millions or billions.</p>
<p>The frantic locking and unlocking of the Mutex turns it into yet another bottleneck, accounting for 20% of total time.</p>
<small>
<!-- https://gohugo.io/content-management/syntax-highlighting/ -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1,323,563,733 (38.60%)  ???:&lt;rtw::objects::sphere::Sphere&lt;T&gt; as rtw::hit::Hittable&lt;T&gt;&gt;::hit
  537,820,968 (15.68%)  ???:rtw::random::random_float
<span style="display:block;width:100%;background-color:#3c3d38">  370,075,224 (10.79%)  ???:pthread_mutex_lock [/usr/lib64/libpthread-2.33.so]
</span><span style="display:block;width:100%;background-color:#3c3d38">  319,030,423 ( 9.30%)  ???:pthread_mutex_unlock [/usr/lib64/libpthread-2.33.so]
</span>  274,479,530 ( 8.00%)  ???:rtw::ray::Ray&lt;T&gt;::color&#39;2
  213,215,525 ( 6.22%)  ???:rtw::ray::Ray&lt;T&gt;::color
  129,769,989 ( 3.78%)  ???:cli::main
  104,789,656 ( 3.06%)  ???:&lt;rtw::material::lambertian::Lambertian&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter
   49,099,401 ( 1.43%)  ???:&lt;rtw::RNG as core::ops::deref::Deref&gt;::deref
   45,736,164 ( 1.33%)  ???:&lt;rtw::material::dielectric::Dielectric&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter
   31,644,376 ( 0.92%)  ???:&lt;rtw::material::metal::Metal&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter</code></pre></div>
</small>
<p>And that&rsquo;s how I left things.  This post is focusing on closing the gap between the WebAssembly module and native, which was pretty successful with only a 13% performance difference.</p>
<p>There&rsquo;s still some low-hanging fruit I&rsquo;d like to optimize later, like removing the lazy_static &amp; Mutex in favor of a faster approach.  I may take the time to simply pass a mutable seed reference down into every corner of the program.  Argument drilling like that is extremely tedious, but it would obviate the need for the Mutex.  Maybe there&rsquo;s a better way to do that in Rust, but I haven&rsquo;t found one yet.</p>
<p>Also, Sphere intersection (<code>Hittable&lt;T&gt;::hit</code>) sits conspicuously at the top of the list, taking up 38.6% of total time.  That could possibly be lowered with spatial filtering (my university ray tracer used a kd-tree), or some geometric shortcuts.</p>
<h4 id="reduce-reuse-recycle-">Reduce, reuse, recycle ♻</h4>
<p>Here&rsquo;s a fun misadventure to share.  To solve the RNG performance problem, I experimented with hard-coding a set of pre-computed random numbers, and then cycling through them over and over again.  I figured —this isn&rsquo;t exactly cryptography— if the set was big it would be good enough for bouncing rays around.</p>
<figure>
<img src="screenshots/raytrace-0.31-fake-rng.png" alt="ray tracing seeded by 100 recycled &quot;random&quot; numbers" />
<figcaption>100 precomputed "random" numbers.</figcaption>
</figure>
<p>The results with 100 numbers were were about as poor as I expected, so I bumped it up to 10,000.</p>
<figure>
<img src="screenshots/raytrace-0.7381-fake-rng.png" alt="ray tracing seeded by 10,000 recycled &quot;random&quot; numbers" />
<figcaption>10,000 precomputed "random" numbers.</figcaption>
</figure>
<p>10,000 gave better results than 100, suggesting the approach could work with a large enough set, but 10,000 was already causing noticeable bloat in the size of the <code>.wasm</code> file, so I pressed <em>undo</em> a bunch of times and vowed never to speak of this again.</p>
<ul>
<li>WWW: Web Workers Work.  trying to make an accurate spinner, but the wasm locks up the main thread, so I&rsquo;m going to try putting it in a web worker.  module worker, specifically.  module worker worked.
<ul>
<li>except in Firefox, which doesn&rsquo;t support module workers.  the worker runs, but can&rsquo;t import, so I modified it to catch the error and return an error message to the main thread.  the main thread then responds by running the renderer on the main thread.  the timer can&rsquo;t tick up anymore because the  main thread is blocked, so I add a message to indicate what&rsquo;s happening.</li>
</ul>
</li>
<li>thank goodnessImageData is a supported type to pass to/from Web Workers: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm</a></li>
<li>just noticed that I&rsquo;m using Rc which is from <code>std</code>.  try to find an alternative that isn&rsquo;t from <code>std</code>, and see what size implications are.
<ul>
<li>trying to remove everything from std, there&rsquo;s more than I thought</li>
<li>trying out <a href="https://crates.io/crates/simple-mutex">https://crates.io/crates/simple-mutex</a> and <a href="https://crates.io/crates/spin-sync">https://crates.io/crates/spin-sync</a>
<ul>
<li>sold on spin-sync.  it&rsquo;s 2kB smaller than std sync, and makes the whole program 22% faster!</li>
</ul>
</li>
<li>trying to replace Rc with wrc.  didn&rsquo;t have the time, really.  Rc is everywhere.</li>
</ul>
</li>
</ul>
<h3 id="page-perf-while-rendering-ie-wwwwww">page perf while rendering, ie WWWWWW</h3>
<p>The flow I aimed to optimize here is this.</p>
<ol>
<li>Fetch &amp; initialize modules</li>
<li>Enable Render button</li>
<li>Begin rendering</li>
<li>Conclude rendering</li>
<li>Display result</li>
</ol>
<p>Each step must happen ASAP, and there should be no delays between steps.</p>
<h4 id="web-worker">Web Worker</h4>
<p>Prevent lockups</p>
<p>Module workers capabilities &amp; browser support.</p>
<h4 id="staircase-liquification">Staircase liquification</h4>
<p>Or, flattening the waterfall.  Optimizing this step involved fetching and initializing the modules needed for rendering, both JS and wasm, as quickly as possible with techniques like prefetching and bundling.</p>
<p>For visual reference, here&rsquo;s the download waterfall at 3G speeds, from the point in time when I first got the wasm module into a good, fast state.  In the waterafll, you&rsquo;ll see as perfect a staircase (not a good thing) as I&rsquo;ve ever seen.</p>
<p><strong>Before</strong>
<img src="screenshots/Screenshot_from_2021-07-10_23-23-07.png" alt=""></p>
<table>
<thead>
<tr>
<th>file</th>
<th>purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>index.html</code></td>
<td>loads <code>wasm-app.js</code>, the main entrypoint</td>
</tr>
<tr>
<td><code>wasm-app.js</code></td>
<td>loads <code>rtw-timer.js</code>, the component that displays running time</td>
</tr>
<tr>
<td><code>wasm-app.js</code></td>
<td>imports the Web Worker, <code>wasm-worker.js</code></td>
</tr>
<tr>
<td><code>wasm-worker.js</code></td>
<td>imports <code>wasm-render.js</code>, the module responsible for running wasm-pack&rsquo;s output.  <code>wasm-render.js</code> can be run either within a Web Worker or without, enabling the ray tracer to run in browsers that don&rsquo;t support module workers, like Firefox.</td>
</tr>
<tr>
<td><code>wasm.js</code></td>
<td>is the JS module generated by wasm-bindgen, responsible for instantiating the wasm module and translating types across the wasm/js boundary</td>
</tr>
<tr>
<td><code>wasm_bg.wasm</code></td>
<td>is the wasm module for the ray tracer</td>
</tr>
</tbody>
</table>
<p>An interesting discovery here is that the tool I usually reach for to preload assets, <code>&lt;link rel=&quot;preload&quot;&gt;</code>, and <code>&lt;link rel=&quot;modulepreload&quot;&gt;</code>, weren&rsquo;t of any use here, for the following reasons.</p>
<p>Preloaded assets must be used within a &ldquo;few seconds&rdquo;, so preload isn&rsquo;t the right choice in a case like this where the goal is to prepare all modules necessary for responding instantaneously to a user event.</p>
<p><img src="screenshots/preload-timeout-warning.png" alt=""></p>
<p>TODO think about removing this whole section about preloading unless I can come up with a less convoluted way of expressing it.</p>
<ul>
<li>browser performance
<ul>
<li>I wanted to preload the resources, but when using modulepreload, the browser didn&rsquo;t like that some of the modules weren&rsquo;t used in the first few seconds.  additionally, wasm files can&rsquo;t be preloaded with link rel=preload.  my workaround to flatten the waterfall was simply to import() the modules and fetch() the wasm immediately.   importing didn&rsquo;t work well because it would execute the modules too, leading to double execution.  so I wound up fetching everything I needed to preload.</li>
<li>have a problem with my measurements here.  my earlier numbers, while evaluating 12-60s wasm slowdown due to rand, were run with quality at 100/66, 4 samples, depth 2, and my later numbers (benchmarks mostly, but also the flamegraphs) were at 300/200, 10 samples, depth 3.  I&rsquo;ll have to re-do something to make the numbers track throughout the blog post.  I think the best I can do is re-do the latest benchmarks at the lower quality.  the flamegraphs don&rsquo;t contain aboslute numbers, and all the measurements in question scale linearly with each other, so they should still be very accurate.</li>
</ul>
</li>
</ul>
<p><strong>After</strong>
<img src="screenshots/Screenshot_from_2021-07-10_23-29-58.png" alt=""></p>
<p>The file sizes shown here are gzipped, and the network speed was throttled to the &ldquo;Fast 3G&rdquo; profile.</p>
<h4 id="slow-performance-when-devtools-is-open">Slow performance when devtools is open</h4>
<p>My initial disappointment at the slow performance was compounded by the fact that WebAssembly runs significantly slower when the devtools panel is open.  By slower, I mean from 2x to 4x slower.  At one point, the ray tracer ran in 840ms with devtools closed, and 2250ms with it open, 2.6x slower.</p>
<p>In all the JS games I&rsquo;ve built, I&rsquo;ve never noticed a performance hit from having from devtools open, so encountering a slowdown in WebAssembly was a surprise.  I took to Twitter to find out why. At <a href="https://twitter.com/rictic/">@rictic</a>&rsquo;s suggestion, I opened a Chromium <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1230610">ticket</a>.</p>
<p>The response from the Chromium team was that this is expected behavior because of something called a &ldquo;Liftoff tier&rdquo;.  &ldquo;What is a Liftoff tier?&rdquo; I wondered.  The v8 blog has the answer: <a href="https://v8.dev/blog/liftoff">Liftoff</a> is a streaming compiler that can initialize a wasm module very quickly, and TurboFan is an optimizing compiler which initializes more slowly, but produces much faster code.  With devtools open, WebAssembly runs exclusively in the Liftoff tier.  Without devtools, WebAssembly will be first initialized with Liftoff so it can begin execution quickly, then individual functions will be gradually replaced with TurboFan-optimized ones.</p>
<p>Liftoff allows deeper inspection, which is why it&rsquo;s active with devtools.</p>
<p>The answer surprised me in one area.  Even though I&rsquo;m not accustomed to slowdowns from devtools, I do expect a performance hit from profiling.  But to my astonishment, the speed returns to normal <em>while the profiler is running</em>.</p>
<p>It&rsquo;s less strange than I first thought, because one thing the profiler does <em>not</em> do is process breakpoints.  Furthermore, the debugger is disabled while profiling for both JS and WebAssembly.  While profiling, WebAssembly seems to be elevated to the faster TurboFan tier, which must accomodate enough inspection to profile, but not to debug.  Thank goodness, because that seems like the tier in which it&rsquo;s most useful to optimize.</p>
<p>The more you know.</p>
<h2 id="whats-next">What&rsquo;s next</h2>
<h2 id="raw-notes">Raw notes</h2>
<ul>
<li>wasm-pack, wasm-bindgen, wasm-opt are awesome.</li>
<li>for this post I tried something new which should have been obvious: keeping the notes open while working on the project and jotting.  typically I have two tmux panes open, one for nvim and one for running the program.  bumped it up to three.  it was incredible how much this helped when sitting down to write this post.  just from the note-taking, I already had almost 1200 words written.</li>
</ul>

  </section>
  <footer>

    

    

    

<section>
  <h3>RELATED POSTS</h3>
  <div class="pbp-related">
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2021/07/rust-raytracer-to-webassembly/">Rust Raytracer to WebAssembly</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        The work of preparing my Rust ray tracer for WebAssembly.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2021-07-05T23:57:49-04:00">
      Jul 5, 2021
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2021/07/rust-raytracer-to-webassembly/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Rust Raytracer to WebAssembly'"
              src="https://clayto.com/2021/07/rust-raytracer-to-webassembly/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">Shaking Off the Rust 1: Ray Tracing in One Weekend</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Learning Rust, one tetanus shot at a time.  In this post, I work on building a Ray Tracer in Many Weekends.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2021-02-08T22:38:50-05:00">
      Feb 8, 2021
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Shaking Off the Rust 1: Ray Tracing in One Weekend'"
              src="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2019/02/how-we-made-command-line-bash/">How We Made Command Line Bash</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A whatsit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2019-02-15T10:21:24-05:00">
      Feb 15, 2019
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2019/02/how-we-made-command-line-bash/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'How We Made Command Line Bash'"
              src="https://clayto.com/2019/02/how-we-made-command-line-bash/clh-bash-thumb.png">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/cee-tribe-display/">CEE Tribe Display</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-18T00:00:00Z">
      May 18, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/cee-tribe-display/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'CEE Tribe Display'"
              src="https://clayto.com/2018/05/cee-tribe-display/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/engage/">Engage</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-04T00:00:00Z">
      May 4, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/engage/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Engage'"
              src="https://clayto.com/2018/05/engage/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">Visualizing Machine Learning with WebGL</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Building a WebGL particle system to visualize machine learning.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-03-14T00:00:00Z">
      Mar 14, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Visualizing Machine Learning with WebGL'"
              src="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
  </div>
</section>




  </footer>
</article>



  </main>
  <footer class="container">
    <section class="pbp-footer">
      
<aside>
  
    <small class="footer-label">CONTACT ME</small>
    
    
    
    
<ul class="pbp-social-links">
  
  <li>
    <a title="Email me" href="mailto:mwc@clayto.com">
      <span class="icon-mail"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my GitHub activity" href="https://github.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-github-squared"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my CodePens" href="https://codepen.io/mwcz" target="_blank" rel="noopener">
      <span class="icon-codepen"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my Twitter" href="https://twitter.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-twitter-squared"></span>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  <li>
    <a title="my Vimeo videos" href="https://vimeo.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-vimeo-squared"></span>
    </a>
  </li>
  
  
  
</ul>


  
</aside>


    </section>

    
    
    
    
    

    
    
    
    
    
    
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js"></script>
  <script>
    anchors.options.visible = 'touch';
    anchors.options.placement = 'right';
    anchors.options.class = 'heading-anchor';
    anchors.add('article > section h1,article > section h2,article > section h3,article > section h4,article > section h5,article > section h6');
  </script>

  
    
  

</body>
</html>

