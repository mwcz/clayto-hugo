<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  
  <meta property="og:title" content="Shaking Off the Rust 2: Ray Tracing in WebAssembly" />
  <meta name="twitter:title" content="Shaking Off the Rust 2: Ray Tracing in WebAssembly" />
  
  <title>Shaking Off the Rust 2: Ray Tracing in WebAssembly - clayto</title>

  
  <meta name="description" content="Learning Rust, one tetanus shot at a time.  In this post: the work of bringing a Rust ray tracer to the web.  WebAssembly, WebAssembly, WebAssembly." />
  <meta property="og:description" content="Learning Rust, one tetanus shot at a time.  In this post: the work of bringing a Rust ray tracer to the web.  WebAssembly, WebAssembly, WebAssembly." />
  <meta name="twitter:description" content="Learning Rust, one tetanus shot at a time.  In this post: the work of bringing a Rust ray tracer to the web.  WebAssembly, WebAssembly, WebAssembly." />
  

  <meta name="author" content="" />
  <meta property="og:site_name" content="clayto" />
  <meta property="og:url" content="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/" />

  
  <meta property="og:image" content="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/thumb.jpg" />
  <meta
    name="twitter:image"
    content="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/thumb.jpg"
  />
  
  <meta name="twitter:card" content="summary" />

  
  <meta name="twitter:site" content="@mwcz" />
  <meta name="twitter:creator" content="@mwcz" />
   
  <meta property="og:type" content="article" />
   
  
  <meta name="generator" content="Hugo 0.81.0" /><link media="screen"
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600"
    rel="stylesheet"
  />
  <link media="screen" rel="stylesheet" href="https://clayto.com/css/styles.min.css" />

  
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://clayto.com/images/favicons/apple-touch-icon.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://clayto.com/images/favicons/favicon-32x32.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://clayto.com/images/favicons/favicon-16x16.png?v=alQ2onMqbL"
  />
  <link rel="manifest" href="https://clayto.com/images/favicons/site.webmanifest?v=alQ2onMqbL" />
  <link
    rel="mask-icon"
    href="https://clayto.com/images/favicons/safari-pinned-tab.svg?v=alQ2onMqbL"
    color="#121212"
  />
  <link rel="shortcut icon" href="https://clayto.com/images/favicons/favicon.ico?v=alQ2onMqbL" />
  <meta name="msapplication-TileColor" content="#121212" />
  <meta
    name="msapplication-config"
    content="/images/favicons/browserconfig.xml?v=alQ2onMqbL"
  />
  <meta name="theme-color" content="#121212" />
   
  
  

</head>

<body>
  
  
  
  
  
  
  
  
  
  
  
  
<header class="pbp-navbar-container">
  
<nav class="pbp-navbar" role="navigation">
  <div class="pbp-nav-logo">
    <a href="https://clayto.com/" title="Home" id="pbp-logo">
      <img src="https://clayto.com/images/logo.png" height="50.4" width="50.4" alt="smiling clayto.com logo">
    </a>
  </div>
  <div class="pbp-navitems">
    
    
    
    <a href="https://clayto.com/" class="pbp-navitem">
      &nbsp;BLOG</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/demos" class="pbp-navitem">
      &nbsp;DEMOS</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/games" class="pbp-navitem">
      &nbsp;GAMES</a>
    
    
  </div>
</nav>




</header>
  <main id="main" role="main" class="container">




  <article class="pbp-article">

  <header>
    <h1>Shaking Off the Rust 2: Ray Tracing in WebAssembly</h1>
  </header>

  

  <div class="pbp-article-meta">
    <time datetime="2021-07-05T23:57:49-04:00">
      Jul 5, 2021
    </time>
    
    <span class="pbp-blue">&middot;</span>
    10 minute read
    <br>
    <span class="pbp-article-tags">
      
      <a href="https://clayto.com/tags/3d" class="c-tag">#3d</a>
      
      <a href="https://clayto.com/tags/programming" class="c-tag">#programming</a>
      
      <a href="https://clayto.com/tags/ray-tracing" class="c-tag">#ray-tracing</a>
      
      <a href="https://clayto.com/tags/rust" class="c-tag">#rust</a>
      
      <a href="https://clayto.com/tags/web" class="c-tag">#web</a>
      
      <a href="https://clayto.com/tags/wasm" class="c-tag">#wasm</a>
      
    </span>
  </div>

  
  
  <section>
    <p>Rust.  A ray tracer.  The dream of WebAssembly.  One idea that could ruin everything.</p>
<p>This was the scene at the end of my <a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">last post</a>, which covered creating a ray tracer in Rust using Peter Shirley&rsquo;s outstanding <a href="https://raytracing.github.io/">Ray Tracing in One Weekend</a>.  In the wrap-up to that post, I expressed an interest in creating a WebAssembly build of the ray tracer, and that project is what follows.</p>
<p>The process of targeting WebAssembly went well, overall.  The highlights of the journey were:</p>
<ul>
<li>
<p>Refactoring crates to support CLI and WebAssembly.</p>
</li>
<li>
<p>Staggering performance degradation caused by millions of excessive wasm-to-js calls.</p>
</li>
<li>
<p>A Rust implementation of a rather fast random number generator.</p>
</li>
<li>
<p>Tanking performance whenever devtools was open.</p>
</li>
</ul>
<p>Before diving in too deep, here&rsquo;s the end result.  This is my Rust ray tracer running right here in this blog post, at speeds pretty close to native.</p>
<script async type="module" src="./rtw-render/dist/rtw-render.js"></script>
<style>
rtw-render {
  --rtw-background-color: var(--pbp-bg-color);
  border: 1px solid var(--pbp-fg-color);
}
#rtw-wrapper {
  display: flex;
  justify-content: center;
}
</style>
<div id="rtw-wrapper">
<rtw-render></rtw-render>
</div>
<p>For fun, try re-rendering a few times to see the &ldquo;noise&rdquo; pattern change.</p>
<hr>
<h2 id="crate-refactoring">Crate refactoring</h2>

  <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#crate-refactoring">Crate refactoring</a></li>
        <li><a href="#performance">Performance</a>
          <ul>
            <li><a href="#mangling-shmangling">Mangling shmangling</a></li>
            <li><a href="#rngesus-giveth-and-taketh-away">RNGesus Giveth and Taketh Away</a>
              <ul>
                <li><a href="#floatuntidfc">floatuntidf.c</a></li>
                <li><a href="#nearly-native">Nearly native</a></li>
                <li><a href="#overheated-mutex">Overheated Mutex</a></li>
                <li><a href="#reduce-reuse-recycle-">Reduce, reuse, recycle â™»</a></li>
              </ul>
            </li>
            <li><a href="#performance-impact-of-devtools">Performance impact of devtools</a></li>
          </ul>
        </li>
        <li><a href="#whats-next">What&rsquo;s next</a></li>
      </ul>
    </li>
  </ul>
</nav>


<style>
pfe-icon {
  --pfe-icon--Color: var(--pbp-fg-color, white);
}
@media (min-width: 750px) {
  #TableOfContents {
    float: right;
    padding: 16px;
    /* margin: 10px; */
    margin: 0 0 10px 20px;
    background-color: #242424;
  }
}
</style>
<p>At the end of the <a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">previous post</a>, the ray tracer could be run only on the command line.  In Rust terms, it was a binary crate.  To re-use that code for a WebAssembly target as well, the first thing I did was move the ray tracing code into a library crate, so it could be imported into both a CLI and WebAssembly.</p>
<p>The original binary crate then imported the library crate, so the CLI could work just as it did before.  I then created another crate using <a href="https://rustwasm.github.io/wasm-pack/book/introduction.html">wasm-pack</a>, a fantastic tool for creating Rust-to-WebAssembly crates.  The wasm crate also imports the library crate and exports a <code>render</code> function to JS with <code>#[wasm_bindgen]</code>.</p>
<p>In Rust land, the <code>render</code> function returns a <code>Vec&lt;u8&gt;</code>.  When <code>render</code> is called in JS land, the <code>Vec&lt;u8&gt;</code> looks like a <code>Uint8ClampedArray</code>.  That slots perfectly into <a href="https://developer.mozilla.org/en-US/docs/Web/API/ImageData"><code>ImageData</code></a>, which is then drawn into a <code>&lt;canvas&gt;</code> using <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/putImageData"><code>putImageData()</code></a>.</p>
<p>That was all it took to get a working WebAssembly module!  Here&rsquo;s the first rendering.</p>
<p><img src="screenshots/first-wasm-render.png" alt="a screenshot of the very first WebAssembly rendering of my ray tracer"></p>
<p>The quality settings were at rock bottom, but it was still pretty exciting!</p>
<p>So, end of post, right?  Well, before we wrap up, maaaybe we should see how good the performance is.</p>
<hr>
<h2 id="performance">Performance</h2>
<p>Initially, the performance of the WebAssembly module seemed pretty good.  The quality settings were bottomed out to make the save/refresh loop tighter.  Once I turned the quality settings back up to their defaults, I was stunned.  The performance was awful.  The WebAssembly module ran <strong>12x</strong> slower than the native binary.  Under some conditions, I even saw it degrade to <strong>60x</strong> native speed.  I won&rsquo;t leave anyone in suspense though, WebAssembly&rsquo;s innate speed was not the cause.</p>
<p>The rest of the post covers why the performance was so poor, how I found the bottlenecks, and how I corrected them.</p>
<hr>
<h3 id="mangling-shmangling">Mangling shmangling</h3>
<p>The first test I ran was a performance profile in Chrome devtools, which profiles JS and WebAssembly.  The results were&hellip; unhelpful.</p>
<p><img src="screenshots/profile-mangled-names.png" alt="screenshot of the mangled names"></p>
<p>wasm-pack docs helped out here.  Adding the two following settings to Cargo.toml resulted in more useful names.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[<span style="color:#a6e22e">package</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">pack</span>.<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>]
<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">opt</span> = <span style="color:#66d9ef">false</span>

[<span style="color:#a6e22e">package</span>.<span style="color:#a6e22e">metadata</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">pack</span>.<span style="color:#a6e22e">profile</span>.<span style="color:#a6e22e">release</span>.<span style="color:#a6e22e">wasm</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">bindgen</span>]
<span style="color:#a6e22e">demangle</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">name</span><span style="color:#960050;background-color:#1e0010">-</span><span style="color:#a6e22e">section</span> = <span style="color:#66d9ef">true</span>
</code></pre></div><figure>
<img src="screenshots/profile-demangled-names.png" alt="screenshot of demangled names" />
<figcaption>
A more helpful profile with demangled names.
</figcaption>
</figure>
<p>With the profile now usable, the first big bottleneck jumped off the screen.</p>
<p><img src="./screenshots/rng-eighty-percent.png" alt="RNG was 80% of the profile"></p>
<p><code>random_float</code> at 80%?  For some reason, generating random numbers taking up most of the oxygen in the room.</p>
<hr>
<h3 id="rngesus-giveth-and-taketh-away">RNGesus Giveth and Taketh Away</h3>
<p>The profile revealed that 80% of the ray tracer&rsquo;s activity consisted of calls to <a href="https://crates.io/crates/rand">rand</a>, an RNG crate.  I&rsquo;d chosen rand because it had WebAssembly support, and includes no calls to the standard library, which tends to cut down on <code>.wasm</code> file size.  What I hadn&rsquo;t noticed until digging into the flame chart, is that when rand is in the WebAssembly context, it gets its initial seed with a call to JS <code>crypto.getRandomValues()</code>, for some high-quality entropy.  And the way I was misusing rand, it was making <em>a lot</em> of those calls.</p>
<p>Random numbers are needed throughout the ray tracer, and I didn&rsquo;t know of a way in Rust to create a single, global RNG that every corner of the program could make calls to.  Instead, I inefficiently initialized a new RNG every time a random number was needed.</p>
<p>This left me with two problems to solve.</p>
<ol>
<li>find a way to share a single RNG</li>
<li>avoid excessive wasm-to-js calls</li>
</ol>
<p>After a lot of experimentation, I settled on implementing <a href="https://lemire.me/blog/2019/03/19/the-fastest-conventional-random-number-generator-that-can-pass-big-crush/">lehmer64</a>, and making it &ldquo;global&rdquo; with <a href="https://crates.io/crates/lazy_static">lazy_static</a>.</p>
<p><strong>lib.rs</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#66d9ef">use</span> lazy_static::lazy_static;
<span style="color:#66d9ef">use</span> std:<span style="color:#a6e22e">sync</span>:<span style="color:#a6e22e">Mutex</span>;

lazy_static<span style="color:#f92672">!</span> {
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">ref</span> RNG: <span style="color:#a6e22e">Mutex</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">u128</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span> Mutex::new(<span style="color:#ae81ff">0xda942042e4dd58b5</span>);
}
</code></pre></div><p>Here&rsquo;s the <a href="https://github.com/mwcz/rust-raytracer-weekend/blob/wasm/lib/src/random.rs">Rust implementation of lehmer64</a>.  The only global piece is the starting seed, which gets rewritten by each call to <code>random_float</code>.  The compiler noticed the potential for integer overflow, and politely asked me to add <a href="https://doc.rust-lang.org/std/num/struct.Wrapping.html">Wrapping</a>.  After addig Wrapping, the code worked.</p>
<p>Without the excessive wasm-to-js calls, performance improved, but not as much as I expected.</p>
<hr>
<h4 id="floatuntidfc">floatuntidf.c</h4>
<p>The culprit, taking up 19% of total time, was <a href="https://github.com/libdfp/libdfp">floatuntidf.c</a>.   It&rsquo;s a temporary C implemntation of 128-bit integers in <a href="https://github.com/rust-lang/compiler-builtins">compiler-builtins</a>, and is being ported to Rust.  Or maybe it&rsquo;s already been ported, but not released, I couldn&rsquo;t tell.  My guess is that the conversion of <code>u128</code> to <code>f64</code> activated floatuntidf.  I lowered the precision to <code>u64/f32</code>, which made <code>Wrapping</code> and <code>floatuntidf</code> unnecessary.  That&rsquo;s a free 19% performance boost with no noticable change in image quality.</p>
<hr>
<h4 id="nearly-native">Nearly native</h4>
<p>Now, the WebAssembly module&rsquo;s speed was breathing down the neck of native!  In the following benchmark, WebAssembly ran at 1.13x native speed.</p>
<table>
<thead>
<tr>
<th>Average total time</th>
<th>Standard deviation</th>
</tr>
</thead>
<tbody>
<tr>
<td>399.20 ms</td>
<td>Â± 4.30 ms</td>
</tr>
<tr>
<td>452.05 ms</td>
<td>Â± 10.85 ms</td>
</tr>
</tbody>
</table>
<p>Native measurements were captured over 30 runs with <a href="https://github.com/sharkdp/hyperfine">hyperfine</a>.  WebAssembly measurements were captured over 30 runs with the Chrome devtools profiler.</p>
<p>Only 1.13x native speed, not bad!  That&rsquo;s within the range I&rsquo;ve heard to expect from WebAssembly.  Under other conditions I&rsquo;ve seen the WebAssembly module perform worse than 1.13x.  The worst case, for this particular module, is approximately 1.5x native speed. The best case is about 1.10x.  The comparison still may not be perfectly fair to the WebAssembly module though, because I took WebAssembly measurements with the Chrome devtools profiler, whereas the native measurements didn&rsquo;t have profiling active.</p>
<hr>
<h4 id="overheated-mutex">Overheated Mutex</h4>
<p>One piece of low-hanging fruit that I haven&rsquo;t pruned yet is the mutex from the code snippet above, which gets extremely overheated. It&rsquo;s used to share mutable access to the RNG seed.  Random numbers are needed throughout the ray tracer, and several are generated per ray.  The quantity of random numbers generated can easily reach into the millions or billions.</p>
<p>The frantic locking and unlocking of the mutex takes up a lot of time.  There&rsquo;s probably a better synchronization technique for this than a mutex; I have a lot to learn about concurrency.</p>
<p>I did eke out a 22% performance gain by replacing <code>std</code> Mutex with <a href="https://crates.io/crates/spin-sync">spin-sync</a> Mutex.  It still gets overheated, taking about 20% of total time, but that&rsquo;s still 22% better than <code>std</code> Mutex.  spin-sync&rsquo;s Mutex also reduced the size of the <code>.wasm</code> module by 2kb, so that&rsquo;s a small win too.  The final gzipped size is around 20-30kb, depending on optimization settings.</p>
<p>Here&rsquo;s the performance profile as it currently stands, with mutex activity highlighted.</p>
<small>
<!-- https://gohugo.io/content-management/syntax-highlighting/ -->
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">1,323,563,733 (38.60%)  ???:&lt;rtw::objects::sphere::Sphere&lt;T&gt; as rtw::hit::Hittable&lt;T&gt;&gt;::hit
  537,820,968 (15.68%)  ???:rtw::random::random_float
<span style="display:block;width:100%;background-color:#3c3d38">  370,075,224 (10.79%)  ???:pthread_mutex_lock [/usr/lib64/libpthread-2.33.so]
</span><span style="display:block;width:100%;background-color:#3c3d38">  319,030,423 ( 9.30%)  ???:pthread_mutex_unlock [/usr/lib64/libpthread-2.33.so]
</span>  274,479,530 ( 8.00%)  ???:rtw::ray::Ray&lt;T&gt;::color&#39;2
  213,215,525 ( 6.22%)  ???:rtw::ray::Ray&lt;T&gt;::color
  129,769,989 ( 3.78%)  ???:cli::main
  104,789,656 ( 3.06%)  ???:&lt;rtw::material::lambertian::Lambertian&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter
   49,099,401 ( 1.43%)  ???:&lt;rtw::RNG as core::ops::deref::Deref&gt;::deref
   45,736,164 ( 1.33%)  ???:&lt;rtw::material::dielectric::Dielectric&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter
   31,644,376 ( 0.92%)  ???:&lt;rtw::material::metal::Metal&lt;T&gt; as rtw::material::Material&lt;T&gt;&gt;::scatter</code></pre></div>
</small>
<hr>
<h4 id="reduce-reuse-recycle-">Reduce, reuse, recycle â™»</h4>
<p>Did I mention an idea that could ruin everything?  Don&rsquo;t tell anyone, but&hellip; to solve the RNG performance problem, I also experimented with hard-coding a set of pre-computed random numbers, and then cycling through them over and over again.  This isn&rsquo;t exctly cryptography, just bouncing rays around.  I figured if the set was big, it might just be good enough.</p>
<p>The question was, how big is big enough?  I tried a low-ball of 100 precomputed &ldquo;random&rdquo; numbers.</p>
<figure>
<img src="screenshots/raytrace-0.31-fake-rng.png" alt="ray tracing seeded by 100 recycled &quot;random&quot; numbers" />
<figcaption>Ray physics governed by 100 precomputed "random" numbers.</figcaption>
</figure>
<p>The results were about as poor as I expected, so I bumped it up to 10,000.</p>
<figure>
<img src="screenshots/raytrace-0.7381-fake-rng.png" alt="ray tracing seeded by 10,000 recycled &quot;random&quot; numbers" />
<figcaption>Ray physics governed by 10,000 precomputed "random" numbers.</figcaption>
</figure>
<p>10,000 gave better results than 100, suggesting the approach could work with a large enough set, but 10,000 was already causing noticeable bloat in the size of the <code>.wasm</code> file, so I pressed <em>undo</em> a bunch of times and vowed never to speak of this again.</p>
<hr>
<h3 id="performance-impact-of-devtools">Performance impact of devtools</h3>
<p>Here&rsquo;s another performance hit from an unexpected source.  WebAssembly runs 2x-4x slower when the devtools panel is open.  For example, the ray tracer ran in 840ms with devtools closed, and 2250ms with it open, 2.6x slower.</p>
<p>In all the JS games I&rsquo;ve built, I&rsquo;ve never noticed a performance hit from having from devtools open, so I was surprised to see WebAssembly take such a hit.  I took to Twitter to find out why. At <a href="https://twitter.com/rictic/">@rictic</a>&rsquo;s suggestion, I opened a Chromium <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1230610">ticket</a>.</p>
<p>The response from the Chromium team was that this is expected behavior because of something called a &ldquo;Liftoff tier&rdquo;.  A what?  The v8 blog has the answer: <a href="https://v8.dev/blog/liftoff">Liftoff</a> is a streaming compiler that can initialize a wasm module very quickly, while TurboFan is an optimizing compiler which initializes more slowly, but produces much faster code.  With devtools open, WebAssembly runs exclusively in the Liftoff tier, accounting for the slowdown.  Without devtools, WebAssembly will be first initialized with Liftoff so it can begin execution quickly, then individual functions will be gradually replaced with TurboFan-optimized ones.</p>
<p>Liftoff allows deeper inspection of the WebAssembly engine, which is why it&rsquo;s activated by devtools.</p>
<p>The answer surprised me in one area.  Even though I&rsquo;m not accustomed to slowdowns from devtools, I do expect a performance hit from profiling.  But to my astonishment, the slowdown vanishes <em>while the profiler is running</em>.</p>
<p>It&rsquo;s less strange than I first thought, because one thing the profiler does <em>not</em> do one important thing: process breakpoints.  While profiling, WebAssembly seems to be elevated to the faster TurboFan tier, which must accomodate enough inspection to profile, but not to debug.  That&rsquo;s good, because profiles from TurboFan are probably more valuable to act on.</p>
<p>The more you know. ðŸŒ </p>
<hr>
<h2 id="whats-next">What&rsquo;s next</h2>
<p>There&rsquo;s still low-hanging fruit I&rsquo;d like to practice optimizing later.  This post is focused on closing the gap between WebAssembly and native, which was pretty successful with only a 13% performance difference.</p>
<p>With more time, I&rsquo;d like to remove the lazy_static/mutex approach in favor of something that doesn&rsquo;t overheat so badly.  I may take the time to simply pass a mutable seed reference down into every corner of the program.  Argument drilling like that is extremely tedious, but it would obviate the need for the mutex.  Maybe someone can show me a better way to do that in Rust.</p>
<p>Also, Sphere intersection (<code>Hittable&lt;T&gt;::hit</code>) sits conspicuously at the top of the profile, taking up 38.6% of total time.  That could be lowered with spatial filtering (my <a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/#redemption">university ray tracer</a> used a kd-tree), or with some magical incantations summoned up by wizened geometers.</p>
<p>Beyond the Rust and WebAssembly optimizations, I have some more conventional &ldquo;hashtag webdev&rdquo; ideas about how best to get WebAssembly on to a page.  I&rsquo;m working on a follow-up post about pairing WebAssembly with Web Workers and Web Components.</p>
<p>Thanks for reading; until next time.</p>

  </section>
  <footer>

    

    

    

<section>
  <h3>RELATED POSTS</h3>
  <div class="pbp-related">
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">Shaking Off the Rust 1: Ray Tracing in One Weekend</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Learning Rust, one tetanus shot at a time.  In this post, I work on building a Ray Tracer in Many Weekends.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2021-02-08T22:38:50-05:00">
      Feb 8, 2021
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Shaking Off the Rust 1: Ray Tracing in One Weekend'"
              src="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2019/02/how-we-made-command-line-bash/">How We Made Command Line Bash</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A whatsit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2019-02-15T10:21:24-05:00">
      Feb 15, 2019
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2019/02/how-we-made-command-line-bash/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'How We Made Command Line Bash'"
              src="https://clayto.com/2019/02/how-we-made-command-line-bash/clh-bash-thumb.png">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/cee-tribe-display/">CEE Tribe Display</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-18T00:00:00Z">
      May 18, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/cee-tribe-display/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'CEE Tribe Display'"
              src="https://clayto.com/2018/05/cee-tribe-display/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/engage/">Engage</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-04T00:00:00Z">
      May 4, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/engage/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Engage'"
              src="https://clayto.com/2018/05/engage/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">Visualizing Machine Learning with WebGL</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Building a WebGL particle system to visualize machine learning.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-03-14T00:00:00Z">
      Mar 14, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Visualizing Machine Learning with WebGL'"
              src="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2017/03/meet-simpixel/">Meet SimPixel</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A WebGL-based visualizer for LED displays.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2017-03-10T00:00:00Z">
      Mar 10, 2017
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2017/03/meet-simpixel/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Meet SimPixel'"
              src="https://clayto.com/2017/03/meet-simpixel/./thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
  </div>
</section>




  </footer>
</article>



  </main>
  <footer class="container">
    <section class="pbp-footer">
      
<aside>
  
    <small class="footer-label">CONTACT ME</small>
    
    
    
    
<ul class="pbp-social-links">
  
  <li>
    <a title="Email me" href="mailto:mwc@clayto.com">
      <span class="icon-mail"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my GitHub activity" href="https://github.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-github-squared"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my CodePens" href="https://codepen.io/mwcz" target="_blank" rel="noopener">
      <span class="icon-codepen"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my Twitter" href="https://twitter.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-twitter-squared"></span>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  <li>
    <a title="my Vimeo videos" href="https://vimeo.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-vimeo-squared"></span>
    </a>
  </li>
  
  
  
</ul>


  
</aside>


    </section>

    
    
    
    
    

    
    
    
    
    
    
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js"></script>
  <script>
    anchors.options.visible = 'touch';
    anchors.options.placement = 'right';
    anchors.options.class = 'heading-anchor';
    anchors.add('article > section h1,article > section h2,article > section h3,article > section h4,article > section h5,article > section h6');
  </script>

  
    
  

</body>
</html>

