<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  
  <meta property="og:title" content="WWWWWW" />
  <meta name="twitter:title" content="WWWWWW" />
  
  <title>WWWWWW - clayto</title>

  
  <meta name="description" content="Optimization techniques for visual wasm modules." />
  <meta property="og:description" content="Optimization techniques for visual wasm modules." />
  <meta name="twitter:description" content="Optimization techniques for visual wasm modules." />
  

  <meta name="author" content="" />
  <meta property="og:site_name" content="clayto" />
  <meta property="og:url" content="https://clayto.com/2021/08/wwwwww/" />

  
  <meta property="og:image" content="https://clayto.com/2021/08/wwwwww/thumb.jpg" />
  <meta
    name="twitter:image"
    content="https://clayto.com/2021/08/wwwwww/thumb.jpg"
  />
  
  <meta name="twitter:card" content="summary" />

  
  <meta name="twitter:site" content="@mwcz" />
  <meta name="twitter:creator" content="@mwcz" />
   
  <meta property="og:type" content="article" />
   
  
  <meta name="generator" content="Hugo 0.81.0" /><link media="screen"
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600"
    rel="stylesheet"
  />
  <link media="screen" rel="stylesheet" href="https://clayto.com/css/styles.min.css" />

  
  <link
    rel="apple-touch-icon"
    sizes="180x180"
    href="https://clayto.com/images/favicons/apple-touch-icon.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="32x32"
    href="https://clayto.com/images/favicons/favicon-32x32.png?v=alQ2onMqbL"
  />
  <link
    rel="icon"
    type="image/png"
    sizes="16x16"
    href="https://clayto.com/images/favicons/favicon-16x16.png?v=alQ2onMqbL"
  />
  <link rel="manifest" href="https://clayto.com/images/favicons/site.webmanifest?v=alQ2onMqbL" />
  <link
    rel="mask-icon"
    href="https://clayto.com/images/favicons/safari-pinned-tab.svg?v=alQ2onMqbL"
    color="#121212"
  />
  <link rel="shortcut icon" href="https://clayto.com/images/favicons/favicon.ico?v=alQ2onMqbL" />
  <meta name="msapplication-TileColor" content="#121212" />
  <meta
    name="msapplication-config"
    content="/images/favicons/browserconfig.xml?v=alQ2onMqbL"
  />
  <meta name="theme-color" content="#121212" />
   
  
  

</head>

<body>
  
  
  
  
  
  
  
  
  
  
  
  
<header class="pbp-navbar-container">
  
<nav class="pbp-navbar" role="navigation">
  <div class="pbp-nav-logo">
    <a href="https://clayto.com/" title="Home" id="pbp-logo">
      <img src="https://clayto.com/images/logo.png" height="50.4" width="50.4" alt="smiling clayto.com logo">
    </a>
  </div>
  <div class="pbp-navitems">
    
    
    
    <a href="https://clayto.com/" class="pbp-navitem">
      &nbsp;BLOG</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/demos" class="pbp-navitem">
      &nbsp;DEMOS</a>
    
    &nbsp;<span class="pbp-nav-separator">&middot;</span>
    
    
    <a href="https://clayto.com/games" class="pbp-navitem">
      &nbsp;GAMES</a>
    
    
  </div>
</nav>




</header>
  <main id="main" role="main" class="container">




  <article class="pbp-article">

  <header>
    <h1>WWWWWW</h1>
  </header>

  

  <div class="pbp-article-meta">
    <time datetime="2021-08-13T00:00:00Z">
      Aug 13, 2021
    </time>
    
    <span class="pbp-blue">&middot;</span>
    4 minute read
    <br>
    <span class="pbp-article-tags">
      
      <a href="https://clayto.com/tags/3d" class="c-tag">#3d</a>
      
      <a href="https://clayto.com/tags/programming" class="c-tag">#programming</a>
      
      <a href="https://clayto.com/tags/ray-tracing" class="c-tag">#ray-tracing</a>
      
      <a href="https://clayto.com/tags/rust" class="c-tag">#rust</a>
      
      <a href="https://clayto.com/tags/web" class="c-tag">#web</a>
      
      <a href="https://clayto.com/tags/wasm" class="c-tag">#wasm</a>
      
      <a href="https://clayto.com/tags/web-components" class="c-tag">#web-components</a>
      
    </span>
  </div>

  
  
  <section>
    <h2 id="recap">RECAP</h2>
<h2 id="i-set-out-to">I SET OUT TO&hellip;</h2>
<h2 id="it-went">IT WENT&hellip;</h2>
<ul>
<li>
<p>Distributing highly-visual WebAssembly modules using Web Workers and Web Components.</p>
</li>
<li>
<p>Some conventional front-end performance optimizations.</p>
</li>
</ul>
<p>Before diving in too deep, here&rsquo;s the result, the ray tracer from my previous post, running right here in this blog post, at speeds pretty close to native.</p>
<script async type="module" src="./rtw-render/dist/rtw-render.js"></script>
<style>
rtw-render {
  --rtw-background-color: var(--pbp-bg-color);

  border: 1px solid var(--pbp-fg-color);

}
</style>
<center>
<rtw-render></rtw-render>
</center>
<h2 id="the-wwwwww-pattern">The WWWWWW Pattern</h2>
<p>The demo above is a WebAssembly module running inside a Web Worker, Wrapped in a Web Component&hellip; on a Web Site, in a Web Browser.  Others are using this same pattern, but to my knowledge it doesn&rsquo;t yet have a silly name.  So, I&rsquo;m dubbing it the <strong>WWWWWW</strong> pattern.  Too many syllables, you say?  I&rsquo;m just following in the footsteps of the man himself.</p>
<figure>
<img src="./wtw-excerpt.jpg" alt="excerpt from Weaving the Web, by Tim Berners-Lee, about how he received early criticism for his &quot;WWW&quot; acronym containing nine syllables" />
<figcaption>Tim Berners-Lee, Weaving the Web</figcaption>
</figure>
<p>Silly names aside, Web Components and Web Workers do complement WebAssembly beautifully.  I&rsquo;d like to write more about WWWWWW, but that&rsquo;ll be a topic for another post.  Back to the ray tracer.</p>
<h2 id="performance">Performance</h2>
<ul>
<li>WWW: Web Workers Work.  trying to make an accurate spinner, but the wasm locks up the main thread, so I&rsquo;m going to try putting it in a web worker.  module worker, specifically.  module worker worked.
<ul>
<li>except in Firefox, which doesn&rsquo;t support module workers.  the worker runs, but can&rsquo;t import, so I modified it to catch the error and return an error message to the main thread.  the main thread then responds by running the renderer on the main thread.  the timer can&rsquo;t tick up anymore because the  main thread is blocked, so I add a message to indicate what&rsquo;s happening.</li>
</ul>
</li>
<li>thank goodnessImageData is a supported type to pass to/from Web Workers: <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm">https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Structured_clone_algorithm</a></li>
</ul>
<h3 id="page-perf-while-rendering-ie-wwwwww">page perf while rendering, ie WWWWWW</h3>
<p>The flow I aimed to optimize here is this.</p>
<ol>
<li>Fetch &amp; initialize modules</li>
<li>Enable Render button</li>
<li>Begin rendering</li>
<li>Conclude rendering</li>
<li>Display result</li>
</ol>
<p>Each step must happen ASAP, and there should be no delays between steps.</p>
<h4 id="web-worker">Web Worker</h4>
<p>Prevent lockups</p>
<p>Module workers capabilities &amp; browser support.</p>
<h4 id="staircase-liquification">Staircase liquification</h4>
<p>Or, flattening the waterfall.  Optimizing this step involved fetching and initializing the modules needed for rendering, both JS and wasm, as quickly as possible with techniques like prefetching and bundling.</p>
<p>For visual reference, here&rsquo;s the download waterfall at 3G speeds, from the point in time when I first got the wasm module into a good, fast state.  In the waterafll, you&rsquo;ll see as perfect a staircase (not a good thing) as I&rsquo;ve ever seen.</p>
<p><strong>Before</strong>
<img src="screenshots/Screenshot_from_2021-07-10_23-23-07.png" alt=""></p>
<table>
<thead>
<tr>
<th>file</th>
<th>purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>index.html</code></td>
<td>loads <code>wasm-app.js</code>, the main entrypoint</td>
</tr>
<tr>
<td><code>wasm-app.js</code></td>
<td>loads <code>rtw-timer.js</code>, the component that displays running time</td>
</tr>
<tr>
<td><code>wasm-app.js</code></td>
<td>imports the Web Worker, <code>wasm-worker.js</code></td>
</tr>
<tr>
<td><code>wasm-worker.js</code></td>
<td>imports <code>wasm-render.js</code>, the module responsible for running wasm-pack&rsquo;s output.  <code>wasm-render.js</code> can be run either within a Web Worker or without, enabling the ray tracer to run in browsers that don&rsquo;t support module workers, like Firefox.</td>
</tr>
<tr>
<td><code>wasm.js</code></td>
<td>is the JS module generated by wasm-bindgen, responsible for instantiating the wasm module and translating types across the wasm/js boundary</td>
</tr>
<tr>
<td><code>wasm_bg.wasm</code></td>
<td>is the wasm module for the ray tracer</td>
</tr>
</tbody>
</table>
<p>An interesting discovery here is that the tool I usually reach for to preload assets, <code>&lt;link rel=&quot;preload&quot;&gt;</code>, and <code>&lt;link rel=&quot;modulepreload&quot;&gt;</code>, weren&rsquo;t of any use here, for the following reasons.</p>
<p>Preloaded assets must be used within a &ldquo;few seconds&rdquo;, so preload isn&rsquo;t the right choice in a case like this where the goal is to prepare all modules necessary for responding instantaneously to a user event.</p>
<p><img src="screenshots/preload-timeout-warning.png" alt=""></p>
<p>TODO think about removing this whole section about preloading unless I can come up with a less convoluted way of expressing it.</p>
<ul>
<li>browser performance
<ul>
<li>I wanted to preload the resources, but when using modulepreload, the browser didn&rsquo;t like that some of the modules weren&rsquo;t used in the first few seconds.  additionally, wasm files can&rsquo;t be preloaded with link rel=preload.  my workaround to flatten the waterfall was simply to import() the modules and fetch() the wasm immediately.   importing didn&rsquo;t work well because it would execute the modules too, leading to double execution.  so I wound up fetching everything I needed to preload.</li>
<li>have a problem with my measurements here.  my earlier numbers, while evaluating 12-60s wasm slowdown due to rand, were run with quality at 100/66, 4 samples, depth 2, and my later numbers (benchmarks mostly, but also the flamegraphs) were at 300/200, 10 samples, depth 3.  I&rsquo;ll have to re-do something to make the numbers track throughout the blog post.  I think the best I can do is re-do the latest benchmarks at the lower quality.  the flamegraphs don&rsquo;t contain aboslute numbers, and all the measurements in question scale linearly with each other, so they should still be very accurate.</li>
</ul>
</li>
</ul>
<p><strong>After</strong>
<img src="screenshots/Screenshot_from_2021-07-10_23-29-58.png" alt=""></p>
<p>The file sizes shown here are gzipped, and the network speed was throttled to the &ldquo;Fast 3G&rdquo; profile.</p>
<h4 id="slow-performance-when-devtools-is-open">Slow performance when devtools is open</h4>
<p>TODO add warning about 2-3x slower perf when devtools is open.  Link to the section in previous post about it.</p>
<h2 id="whats-next">What&rsquo;s next</h2>

  </section>
  <footer>

    

    

    

<section>
  <h3>RELATED POSTS</h3>
  <div class="pbp-related">
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/">Shaking Off the Rust 2: Ray Tracing in WebAssembly</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Learning Rust, one tetanus shot at a time.  In this post: the work of bringing a Rust ray tracer to the web.  WebAssembly, WebAssembly, WebAssembly.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2021-07-05T23:57:49-04:00">
      Jul 5, 2021
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-top"
              loading="lazy"
              alt="thumbnail for 'Shaking Off the Rust 2: Ray Tracing in WebAssembly'"
              src="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/thumb.png">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">Shaking Off the Rust 1: Ray Tracing in One Weekend</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Learning Rust, one tetanus shot at a time.  In this post, I work on building a Ray Tracer in Many Weekends.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2021-02-08T22:38:50-05:00">
      Feb 8, 2021
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Shaking Off the Rust 1: Ray Tracing in One Weekend'"
              src="https://clayto.com/2021/02/shaking-off-the-rust-1-ray-tracing-in-one-weekend/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2019/02/how-we-made-command-line-bash/">How We Made Command Line Bash</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A whatsit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2019-02-15T10:21:24-05:00">
      Feb 15, 2019
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2019/02/how-we-made-command-line-bash/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'How We Made Command Line Bash'"
              src="https://clayto.com/2019/02/how-we-made-command-line-bash/clh-bash-thumb.png">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/cee-tribe-display/">CEE Tribe Display</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-18T00:00:00Z">
      May 18, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/cee-tribe-display/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'CEE Tribe Display'"
              src="https://clayto.com/2018/05/cee-tribe-display/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/05/engage/">Engage</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        A game for Red Hat Summit.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-05-04T00:00:00Z">
      May 4, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/05/engage/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Engage'"
              src="https://clayto.com/2018/05/engage/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
    <article class="pbp-article-li pbp-article-loadmore vertical">
  <h2 class="pbp-article-title"><a href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">Visualizing Machine Learning with WebGL</a></h2>
  <div class="pbp-article-summary">
    <section>
      
        Building a WebGL particle system to visualize machine learning.
      
    </section>
  </div>
  <div class="pbp-article-meta">
    <time datetime="2018-03-14T00:00:00Z">
      Mar 14, 2018
    </time>
  </div>
  
  <a tabindex="-1" class="pbp-article-thumbnail" href="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/">
    <div class="pbp-article-thumbnail">
      
      <div class="glass-card">
      
        <div class="glass-card-ratio">
          <picture>
            
            
            
               
            
            <img
              class="glass-card-bg glass-card-bg-default"
              loading="lazy"
              alt="thumbnail for 'Visualizing Machine Learning with WebGL'"
              src="https://clayto.com/2018/03/visualizing-machine-learning-with-webgl/thumb.jpg">
          </picture>
          <div class="glass-card-border-outer"></div>
          <div class="glass-card-border-inner"></div>
          
          
          
          
          
        </div>
      </div>
    </div>
  </a>
  
</article>

    
    
  </div>
</section>




  </footer>
</article>



  </main>
  <footer class="container">
    <section class="pbp-footer">
      
<aside>
  
    <small class="footer-label">CONTACT ME</small>
    
    
    
    
<ul class="pbp-social-links">
  
  <li>
    <a title="Email me" href="mailto:mwc@clayto.com">
      <span class="icon-mail"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my GitHub activity" href="https://github.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-github-squared"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my CodePens" href="https://codepen.io/mwcz" target="_blank" rel="noopener">
      <span class="icon-codepen"></span>
    </a>
  </li>
  
  
  <li>
    <a title="my Twitter" href="https://twitter.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-twitter-squared"></span>
    </a>
  </li>
  
  
  
  
  
  
  
  
  
  
  
  
  <li>
    <a title="my Vimeo videos" href="https://vimeo.com/mwcz" target="_blank" rel="noopener">
      <span class="icon-vimeo-squared"></span>
    </a>
  </li>
  
  
  
</ul>


  
</aside>


    </section>

    
    
    
    
    

    
    
    
    
    
    
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.3.1/anchor.min.js"></script>
  <script>
    anchors.options.visible = 'touch';
    anchors.options.placement = 'right';
    anchors.options.class = 'heading-anchor';
    anchors.add('article > section h1,article > section h2,article > section h3,article > section h4,article > section h5,article > section h6');
  </script>

  
    
  

</body>
</html>

